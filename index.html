<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bachelor Point Season 5</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{--p:#e63946;--s:#1d3557}
body{margin:0;font-family:sans-serif;background:#f0f2f5;padding-bottom:90px}

.header{
background:linear-gradient(135deg,var(--p),var(--s));
color:#fff;
text-align:center;
padding:40px;
border-radius:0 0 35px 35px
}
.header h2{
font-size:32px;
font-weight:900;
margin:0
}
.header p{
font-size:20px;
font-weight:800;
margin:5px 0 0
}

.folder{display:flex;gap:10px;justify-content:center;margin:-25px 15px 15px}
.folder button{padding:10px 18px;border-radius:15px;border:2px solid var(--p);background:#fff;font-weight:bold}
.folder .active{background:linear-gradient(135deg,var(--p),var(--s));color:#fff;border:none}
.search{padding:0 20px}
.search input{width:100%;padding:14px;border-radius:15px;border:2px solid #ddd}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;padding:20px}
.card{background:#fff;border-radius:25px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.08)}
.thumb img{width:100%;height:170px;object-fit:cover}
.card-body{padding:15px;text-align:center}
.card-body h3{font-size:16px;margin:5px 0 10px}
.card-body small{display:flex;justify-content:space-between;margin-bottom:10px;font-weight:bold}
button.main{width:100%;padding:14px;border-radius:15px;border:none;font-size:15px;font-weight:bold}
.unlock{background:linear-gradient(135deg,var(--p),var(--s));color:#fff}
.download{background:linear-gradient(135deg,#00c853,#007a33);color:#fff}
.locked{background:#eee;color:#777}

#overlay{
display:none;
position:fixed;
bottom:0;
left:0;
width:100%;
height:65px;
background:#000;
color:#fff;
z-index:9999;
align-items:center;
justify-content:center;
font-size:22px;
font-weight:bold
}
</style>
</head>

<body>

<div id="overlay">‚è≥ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>

<div class="header">
<h2>Bachelor Point</h2>
<p>Season 5</p>
</div>

<div class="folder">
<button class="active" onclick="setCat('All',this)">üìÅ ALL</button>
<button onclick="setCat('BP S5',this)">üìÅ BP S5</button>
</div>

<div class="search">
<input id="searchBox" placeholder="Episode ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." oninput="render()">
</div>

<div class="grid" id="videos">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>

<script>
const REQUIRED_SEC = 10;
const LOCK_TIME = 24*60*60*1000;
const BOT_USERNAME = "Bachelor_Point_Season_5_ep_bot";

const tg = Telegram.WebApp; tg.expand();
firebase.initializeApp({databaseURL:"https://bachelor-point-season-5-default-rtdb.firebaseio.com/"});
const db = firebase.database();

let allVideos={}, currentCat="All";
let verifyTimer=null;

/* LOAD */
db.ref("videos").on("value",s=>{
 allVideos=s.val()||{};
 render();
});

/* CATEGORY */
function setCat(c,b){
 currentCat=c;
 document.querySelectorAll(".folder button").forEach(x=>x.classList.remove("active"));
 b.classList.add("active");
 render();
}

/* RENDER */
function render(){
 const q=document.getElementById("searchBox").value.trim();
 const box=document.getElementById("videos");
 box.innerHTML="";
 for(let id in allVideos){
  const v=allVideos[id];
  if(currentCat!=="All" && v.category!==currentCat) continue;
  if(q && !v.name.match(new RegExp("Episode\\s*"+q,"i"))) continue;

  const step=parseInt(localStorage.getItem("step_"+id)||0);
  const lock=parseInt(localStorage.getItem("lock_"+id)||0);
  const total=v.ads.length;

  let btnClass="unlock",btnText="üîí Unlock Video",action=`startAd('${id}')`;

  if(lock && Date.now()<lock){
    btnClass="locked"; btnText="üì© ‡¶á‡¶®‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßã";
    action=`lockedNotice()`;
  }else if(step>=total){
    btnClass="download"; btnText="üì• Download Video";
    action=`download('${id}')`;
  }

  box.innerHTML+=`
  <div class="card">
    <div class="thumb"><img src="${v.photo}"></div>
    <div class="card-body">
      <h3>${v.name}</h3>
      <small><span>‡¶ß‡¶æ‡¶™: ${step}/${total}</span><span>${v.category}</span></small>
      <button class="main ${btnClass}" onclick="${action}">${btnText}</button>
    </div>
  </div>`;
 }
}

/* AD START ‚Äì FIXED */
function startAd(id){
 const v=allVideos[id];
 const step=parseInt(localStorage.getItem("step_"+id)||0);
 const link=v.ads[step];

 localStorage.setItem("ad","1");
 localStorage.setItem("ad_id",id);
 localStorage.setItem("ad_start",Date.now());

 document.getElementById("overlay").style.display="flex";

 if(verifyTimer) clearInterval(verifyTimer);
 verifyTimer=setInterval(verify,1000);

 Telegram.WebApp.openLink(link,{try_instant_view:false});
}

/* VERIFY ‚Äì AUTO RETURN FIX */
function verify(){
 if(localStorage.getItem("ad")!=="1") return;

 const spent=Math.floor((Date.now()-parseInt(localStorage.getItem("ad_start")))/1000);
 if(spent<REQUIRED_SEC) return;

 const id=localStorage.getItem("ad_id");
 localStorage.removeItem("ad");
 clearInterval(verifyTimer);
 document.getElementById("overlay").style.display="none";

 localStorage.setItem("step_"+id,(parseInt(localStorage.getItem("step_"+id)||0)+1));
 Swal.fire("‡¶∏‡¶´‡¶≤","‡ßß‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡ßü‡ßá‡¶õ‡ßá","success").then(render);
}

/* DOWNLOAD */
function download(id){
 localStorage.setItem("lock_"+id,Date.now()+LOCK_TIME);
 localStorage.setItem("step_"+id,0);
 Swal.fire("‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá","‡¶á‡¶®‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®","success")
 .then(()=>location.href=`https://t.me/${BOT_USERNAME}?start=${id}`);
}

/* LOCK */
function lockedNotice(){
 Swal.fire("‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá","‡ß®‡ß™ ‡¶ò‡¶®‡ßç‡¶ü‡¶æ ‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®","info");
}

/* LIFE CYCLE FALLBACK */
document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="visible")verify();});
window.addEventListener("pageshow",verify);
window.onfocus=verify;
</script>

</body>
</html>
